<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Panel - Control Servos / Vigilancia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
    <style>
        body {
            background: #0b1220;
            color: #fff;
        }

        .card {
            background: #0f1720;
            border: 1px solid #222;
        }

        .big-btn {
            padding: 14px;
            font-size: 18px;
        }

        #joystickZone {
            width: 260px;
            height: 260px;
            margin: auto;
            border-radius: 50%;
            background: #0b1720;
        }

        .log {
            max-height: 200px;
            overflow: auto;
            white-space: pre-line;
            background: #071018;
            padding: 10px;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="row mb-3">
            <div class="col-12 text-center">
                <h2>Control Servos & Vigilancia</h2>
                <p id="ipInfo">Conectado a: <strong>192.168.102.171</strong></p>
            </div>
        </div>

        <div class="row g-3">
            <!-- Panel de control -->
            <div class="col-md-6">
                <div class="card p-3">
                    <h4>Controles</h4>
                    <div id="modeButtons" class="d-grid gap-2">
                        <button id="btnManual" class="btn btn-primary big-btn">Manual</button>
                        <button id="btnRandom" class="btn btn-warning big-btn">Aleatorio</button>
                        <button id="btnSweep" class="btn btn-info big-btn">Barrido</button>
                    </div>

                    <div id="activeControls" class="mt-3 d-none">
                        <div id="manualArea" class="text-center d-none">
                            <div id="joystickZone"></div>
                            <p class="mt-2">Joystick virtual — mueve ambos servos</p>
                        </div>

                        <div id="stopArea" class="text-center d-none">
                            <button id="btnStop" class="btn btn-danger big-btn">Detener modo</button>
                        </div>
                    </div>

                    <hr />

                    <div class="d-flex gap-2">
                        <button id="btnVigilance" class="btn btn-success">Vigilancia: ON</button>
                        <button id="btnRefresh" class="btn btn-secondary">Actualizar estado</button>
                    </div>

                    <div class="mt-3">
                        <small>Estado: <span id="statusText">--</span></small>
                    </div>
                </div>
            </div>

            <!-- Panel historial -->
            <div class="col-md-6">
                <div class="card p-3">
                    <h4>Historial de detecciones</h4>
                    <div id="logBox" class="log mb-2">Cargando...</div>
                    <button id="btnDownload" class="btn btn-outline-light">Descargar historial</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ESP_IP = "192.168.102.171";   // tu IP
        const WS_PORT = 81;
        let ws = null;
        let nipple = null;
        let currentMode = "menu";

        // util
        async function api(path) {
            try {
                const r = await fetch(`http://${ESP_IP}${path}`);
                return r;
            } catch (e) {
                console.error("API fetch error:", e);
                return null;
            }
        }

        async function setMode(m) {
            await api(`/mode?set=${m}`);
            updateUI();
        }

        async function setVigilance(on) {
            await api(`/vigilance?set=${on ? "on" : "off"}`);
            updateUI();
        }

        async function fetchStatus() {
            const r = await api('/status');
            if (!r) return null;
            try { return await r.json(); } catch (e) { return null; }
        }

        async function fetchLogText() {
            const r = await api('/log');
            if (!r) return "error";
            return await r.text();
        }

        function openWS() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            ws = new WebSocket(`ws://${ESP_IP}:${WS_PORT}/`);
            ws.onopen = () => console.log("WS conectado");
            ws.onclose = () => { console.log("WS cerrado"); setTimeout(openWS, 1000); };
            ws.onerror = e => console.log("WS err", e);
            ws.onmessage = evt => console.log("WS msg:", evt.data);
        }

        function startJoystick() {
            if (nipple) return;
            const zone = document.getElementById('joystickZone');
            nipple = nipplejs.create({
                zone: zone, mode: 'static', position: { left: '50%', top: '50%' },
                color: 'white', size: 220
            });
            nipple.on('move', function (evt, data) {
                if (!data || !data.vector) return;
                let vx = Math.round(data.vector.x * 90) + 90; // 0..180
                let vy = Math.round(-data.vector.y * 90) + 90;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    // enviar X,Y juntos
                    ws.send(`X${vx},Y${vy}`);
                }
            });
            nipple.on('end', () => { if (ws && ws.readyState === WebSocket.OPEN) ws.send('X90,Y90'); });
        }

        function stopJoystick() {
            if (nipple) { nipple.destroy(); nipple = null; }
        }

        // UI updates
        async function updateUI() {
            const st = await fetchStatus();
            if (!st) {
                document.getElementById('statusText').innerText = "No responde";
                return;
            }
            currentMode = st.mode;
            document.getElementById('statusText').innerText = `Modo: ${st.mode} | Vigilancia: ${st.vigilance ? "ON" : "OFF"} | Laser: ${st.laser ? "ON" : "OFF"}`;
            document.getElementById('btnVigilance').innerText = st.vigilance ? "Vigilancia: ON" : "Vigilancia: OFF";
            document.getElementById('btnVigilance').className = st.vigilance ? "btn btn-success" : "btn btn-outline-secondary";

            // mostrar controles según modo
            const activeControls = document.getElementById('activeControls');
            const manualArea = document.getElementById('manualArea');
            const stopArea = document.getElementById('stopArea');

            if (st.mode === "manual") {
                activeControls.classList.remove('d-none');
                manualArea.classList.remove('d-none');
                stopArea.classList.remove('d-none');
                startJoystick();
            } else if (st.mode === "aleatorio" || st.mode === "barrido") {
                activeControls.classList.remove('d-none');
                manualArea.classList.add('d-none');
                stopArea.classList.remove('d-none');
                stopJoystick();
            } else {
                activeControls.classList.add('d-none');
                manualArea.classList.add('d-none');
                stopArea.classList.add('d-none');
                stopJoystick();
            }

            // fetch log
            const logtxt = await fetchLogText();
            document.getElementById('logBox').innerText = logtxt;
        }

        document.getElementById('btnManual').addEventListener('click', () => { setMode('manual'); openWS(); });
        document.getElementById('btnRandom').addEventListener('click', () => { setMode('random'); openWS(); });
        document.getElementById('btnSweep').addEventListener('click', () => { setMode('sweep'); openWS(); });
        document.getElementById('btnStop').addEventListener('click', () => { setMode('menu'); openWS(); });

        document.getElementById('btnVigilance').addEventListener('click', async () => {
            const st = await fetchStatus();
            if (!st) return;
            setVigilance(!st.vigilance);
        });

        document.getElementById('btnRefresh').addEventListener('click', updateUI);
        document.getElementById('btnDownload').addEventListener('click', async () => {
            const txt = await fetchLogText();
            const blob = new Blob([txt], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'historial_detecciones.txt';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        });

        // iniciar
        openWS();
        updateUI();
        setInterval(updateUI, 2500);
    </script>
</body>

</html>
